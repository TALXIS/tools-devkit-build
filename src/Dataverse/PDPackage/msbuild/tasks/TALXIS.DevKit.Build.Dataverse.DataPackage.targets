<Project>
  <PropertyGroup>
    <DataPackageSearchRoot Condition="'$(DataPackageSearchRoot)'==''">
      $([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)'))
    </DataPackageSearchRoot>

    <DataPackageOutputDir Condition="'$(DataPackageOutputDir)'=='' and '$(TargetDir)'!=''">
      $([System.IO.Path]::Combine('$([System.IO.Path]::GetFullPath('$(TargetDir)'))','DataPackages'))
    </DataPackageOutputDir>
    <DataPackageOutputDir Condition="'$(DataPackageOutputDir)'==''">
      $([System.IO.Path]::Combine('$([System.IO.Path]::GetFullPath('$(OutputPath)'))','DataPackages'))
    </DataPackageOutputDir>

    <DataPackageOutputDir>$([System.Text.RegularExpressions.Regex]::Replace('$(DataPackageOutputDir)', '[\\/]*$', ''))\</DataPackageOutputDir>
  </PropertyGroup>

  <Target Name="TalxisDiscoverDataPackages">
    <ItemGroup>
      <_DataPackageCandidates Include="$(DataPackageSearchRoot)**\[Content_Types].xml"
                               Condition="Exists('$([System.IO.Path]::Combine('$([System.IO.Path]::GetDirectoryName('%(FullPath)'))','data_schema.xml'))') and
                                          Exists('$([System.IO.Path]::Combine('$([System.IO.Path]::GetDirectoryName('%(FullPath)'))','data.xml'))')">
        <PackageDir>$([System.IO.Path]::GetDirectoryName('%(FullPath)'))</PackageDir>
      </_DataPackageCandidates>
    </ItemGroup>

    <ItemGroup>
      <_DataPackageDirs Include="@(_DataPackageCandidates->'%(PackageDir)')" Distinct="true" />
    </ItemGroup>

    <Message Text="Detected data packages: @(_DataPackageDirs)" Importance="High" Condition="'@(_DataPackageDirs)'!=''" />
  </Target>

  <Target Name="TalxisZipDataPackages"
          AfterTargets="Build"
          DependsOnTargets="TalxisDiscoverDataPackages"
          Condition="'@(_DataPackageDirs)'!=''">

    <MakeDir Directories="$(DataPackageOutputDir)" />

    <ItemGroup>
      <_DataPackageZips Include="@(_DataPackageDirs)">
        <ZipFile>$(DataPackageOutputDir)$([System.IO.Path]::GetFileName('%(Identity)')).zip</ZipFile>
      </_DataPackageZips>
    </ItemGroup>

    <Message Text="Zipping data packages: @(_DataPackageZips->'%(Identity) -> %(ZipFile)', ', ')" Importance="High" />

    <ZipDirectory SourceDirectory="%(Identity)"
                  DestinationFile="%(ZipFile)"
                  Overwrite="true" />
  </Target>
</Project>
