<?xml version="1.0" encoding="utf-8"?>

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="ProbeScriptLibraries"
          BeforeTargets="BuildScriptLibraries"
          Condition="'@(ProjectReference)'!=''">

    <MSBuild Projects="@(ProjectReference->'%(FullPath)')"
             Targets="GetProjectType"
             Properties="Configuration=$(Configuration)"
             BuildInParallel="true"
             SkipNonexistentTargets="true">
      <Output TaskParameter="TargetOutputs" ItemName="_ProjectTypeFromReferences" />
    </MSBuild>

    <ItemGroup>
      <_ScriptLibraryProjects Remove="@(_ScriptLibraryProjects)" />
      <_ScriptLibraryProjects Include="@(_ProjectTypeFromReferences)"
                              Condition="'%(ProjectType)'=='ScriptLibrary'" />
    </ItemGroup>

    <Message Importance="high"
             Text="Detected ScriptLibrary projects: @(_ScriptLibraryProjects)"
             Condition="'@(_ScriptLibraryProjects)'!=''" />
  </Target>

  <Target Name="BuildScriptLibraries"
          BeforeTargets="CoreCompile"
          DependsOnTargets="ProbeScriptLibraries"
          Condition="'@(ProjectReference)'!=''">

    <MSBuild Projects="@(ProjectReference->'%(FullPath)')"
             Targets="GetScriptLibraryOutputs"
             Properties="Configuration=$(Configuration);RunNodeBuild=true"
             BuildInParallel="true"
             SkipNonexistentTargets="true">
      <Output TaskParameter="TargetOutputs" ItemName="_ScriptLibraryOutputs" />
    </MSBuild>

    <Message Importance="high"
             Text="Script library outputs: @(_ScriptLibraryOutputs)"
             Condition="'@(_ScriptLibraryOutputs)'!=''" />
  </Target>

  <Target Name="FixWebResourcesDir"
          BeforeTargets="CopyScriptLibrariesToWebResources"
          Condition="'$(WebResourcesDir)'=='' and '$(SolutionRootPath)'!=''">
    <PropertyGroup>
      <WebResourcesDir>$(MSBuildProjectDirectory)\$(SolutionRootPath)\WebResources\</WebResourcesDir>
    </PropertyGroup>
  </Target>

  <Target Name="CopyScriptLibrariesToWebResources"
          AfterTargets="BuildScriptLibraries"
          BeforeTargets="CoreCompile"
          Condition="'@(_ScriptLibraryOutputs)'!=''">

    <MakeDir Directories="$(WebResourcesDir)" />

    <ItemGroup>
      <_ScriptFiles Include="@(_ScriptLibraryOutputs)" />
      <_ScriptFilesToCopy Include="@(_ScriptFiles)">
        <DestFile>
          $(WebResourcesDir)$(PublisherPrefix)_$([System.IO.Path]::GetFileName('%(Identity)'))</DestFile>
        <WebResourceName>$(PublisherPrefix)_$([System.IO.Path]::GetFileName('%(Identity)'))</WebResourceName>
        <DisplayName>$([System.IO.Path]::GetFileName('%(Identity)'))</DisplayName>
        <DataXmlFile>$(WebResourcesDir)$(PublisherPrefix)_$([System.IO.Path]::GetFileName('%(Identity)')).data.xml</DataXmlFile>
      </_ScriptFilesToCopy>
    </ItemGroup>

    <Message Importance="high"
             Text="Copy scripts: @(_ScriptFilesToCopy->'%(Identity) -> %(DestFile)', ', ')" />

    <Copy SourceFiles="@(_ScriptFilesToCopy)"
          DestinationFiles="%(DestFile)"
          SkipUnchangedFiles="true"
          OverwriteReadOnlyFiles="true" />

    <ItemGroup>
      <_ScriptFilesMissingDataXml Include="@(_ScriptFilesToCopy)"
                                  Condition="!Exists('%(DataXmlFile)')">
      </_ScriptFilesMissingDataXml>
    </ItemGroup>

    <Message Importance="high"
             Text="Generate webresource data.xml: @(_ScriptFilesMissingDataXml->'%(DataXmlFile)', ', ')"
             Condition="'@(_ScriptFilesMissingDataXml)'!=''" />

    <EnsureWebResourceDataXml DataXmlFile="%(_ScriptFilesMissingDataXml.DataXmlFile)"
                              WebResourceName="%(_ScriptFilesMissingDataXml.WebResourceName)"
                              DisplayName="%(_ScriptFilesMissingDataXml.DisplayName)"
                              Condition="'@(_ScriptFilesMissingDataXml)'!=''" />
  </Target>

  <Target Name="EnsureScriptLibraryRootComponents"
          AfterTargets="CopyScriptLibrariesToWebResources"
          Condition="'@(_ScriptFilesToCopy)'!='' and '$(SolutionPackagerMetadataWorkingDirectory)'!='' and Exists('$(SolutionPackagerMetadataWorkingDirectory)\\Other\\Solution.xml')">

    <ItemGroup>
      <_ScriptWebResources Include="@(_ScriptFilesToCopy)"
                           Condition="'%(_ScriptFilesToCopy.WebResourceName)'!=''" />
    </ItemGroup>

    <EnsureSolutionRootComponents SolutionXml="$(SolutionPackagerMetadataWorkingDirectory)\Other\Solution.xml"
                                  WebResources="@(_ScriptWebResources)" />
  </Target>

  <Target Name="EnsureCustomNode" AfterTargets="BuildScriptLibraries">
    <EnsureCustomizationsNode
      CustomizationsXmlFile="$(ProjectDir)$(SolutionRootPath)\Other\Customizations.xml"
      NodeName="WebResources" />
  </Target>

</Project>
